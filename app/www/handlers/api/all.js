/**
 * API: List all packages.
 *
 * This component provides a handler that generates a list of all packages.
 *
 * The file format generated by this handler is intended to be compatible with
 * npm's meta API v1 [all](https://github.com/npm/registry/blob/master/docs/REGISTRY-API.md#get-all)
 * endpoint.  Note that npm has [deprecated](http://blog.npmjs.org/post/157615772423/deprecating-the-all-registry-endpoint)
 * this endpoint, but historical sample responses can be viewed at the Internet
 * Archive:
 *   - 2012/08/24 - https://web.archive.org/web/20120824150709/https://registry.npmjs.org/-/all
 *   - 2015/05/15 - https://web.archive.org/web/20150515053712/https://registry.npmjs.org/-/all
 *
 * After the deprecation, the Internet Archive recorded a response in the following format:
 *   ```
 *   {"message":"deprecated"}
 *   ```
 *   - 2018/02/18 - https://web.archive.org/web/20180218131402/https://registry.npmjs.org/-/all
 *
 * However, when fetching the endpoint directly at time of writing, a response in the
 * following format is returned:
 *   ```
 *   []
 *   ```
 *   - 2018/09/22 - https://registry.npmjs.org/-/all
 *
 * When generating a deprecated file, the ambiguity is resolved in favor of the
 * latest known format (a zero-length array).
 */
exports = module.exports = function() {
  var uri = require('url');
  
  function deprecated(page) {
    page.write(JSON.stringify([]));
    page.end();
  }
  
  function render(page, next) {
    var packages = page.site.pages.filter(function(p) {
      return (p.meta && p.meta.package == true);
    });
    
    
    var json = {};
    
    packages.forEach(function(p) {
      var obj = {};
      obj.name = p.locals.name;
      obj.description = p.locals.description;
      obj.keywords = p.locals.keywords;
      obj['dist-tags'] = { latest: p.locals.version };
      obj.versions = {};
      obj.versions[p.locals.version] = 'latest';
      if (p.locals.publishedAt) {
        obj.time = { modified: p.locals.publishedAt.toISOString() };
      }
      
      if (p.locals.flags) {
        obj._flags = p.locals.flags;
      }
      if (p.locals.count) {
        obj._count = p.locals.count;
      }
      if (p.locals.downloads) {
        obj._downloads = p.locals.downloads;
      }
      
      json[p.locals.name] = obj;
    });
    
    page.write(JSON.stringify(json, null, 2));
    page.end();
  }
  
  
  return [
    //deprecated,
    render
  ];
};

exports['@require'] = [];
